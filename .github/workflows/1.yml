name: FongMi
on:
  workflow_dispatch:
    inputs:
      x5kernel:
        description: "é»˜è®¤ä¸æ”¯æŒx5"
        required: false
        default: "NoAddx5kernel"
        type: choice
        options:
          - NoAddx5kernel
          - Addx5kernel
      user_godown:
        description: "é€‰æ‹© TV æºåˆ†æ”¯"
        required: false
        default: "FongMi/TV"
        type: choice
        options:
          - FongMi/TV
          - okcaptain/TV
          - jadehh/FongMiTV
          - LyOuYang/TV
      source_branch:
        description: "é€‰æ‹© TV åˆ†æ”¯"
        required: false
        default: "release"
        type: choice
        options:
          - release
          - dev
          - fongmi
          - kitkat
env:
    GITHUB_WORKSPACE: ${{ github.workspace }}
    GRADLE_TASKS: assembleLeanbackPythonArm64_v8aRelease assembleLeanbackPythonArmeabi_v7aRelease assembleMobilePythonArm64_v8aRelease assembleMobilePythonArmeabi_v7aRelease
    

jobs:
  build:
    name: framework:${{ matrix.framework}})
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    strategy:
      fail-fast: false
      matrix:
        framework: ["assembleLeanbackJavaArm64_v8aRelease",
                    "assembleLeanbackJavaArmeabi_v7aRelease",
                    "assembleLeanbackPythonArm64_v8aRelease",
                    "assembleLeanbackPythonArmeabi_v7aRelease",
                    "assembleMobileJavaArm64_v8aRelease",
                    "assembleMobileJavaArmeabi_v7aRelease",
                    "assembleMobilePythonArm64_v8aRelease",
                    "assembleMobilePythonArmeabi_v7aRelease"]
    steps:
      - name: è®¾ç½®å¼€å§‹æ—¶é—´
        run: |
          echo "VERSION=$(curl -s "https://raw.githubusercontent.com/${{ inputs.user_godown }}/${{ inputs.source_branch }}/app/build.gradle" | grep 'versionName' | cut -d\" -f2)" >> $GITHUB_ENV
          echo 'è¯»å–æºç‰ˆæœ¬ä¿¡æ¯å®Œæˆ'
          echo "tag=$(date "+%Y.%m.%d-%H.%M")" >> $GITHUB_ENV
          echo 'è®¾ç½®å‘å¸ƒæ—¶é—´ç”¨äºtagæ ‡ç­¾å®Œæˆ'
          echo "codeteme=$(date "+%y%m")" >> $GITHUB_ENV
          echo 'è®¾ç½®å¹´æœˆæ—¶é—´ä¸ºversionCodeå®Œæˆ'
          echo "bteme=$(date "+%y.%m.%d")" >> $GITHUB_ENV
          echo 'è®¾ç½®å¹´æœˆæ—¥æ—¶é—´ä¸ºversionNameå®Œæˆ'
          START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV
          echo 'è®¾ç½®å¼€å§‹æ—¶é—´å®Œæˆ'

      - name: è¯»å–mytvboxæ•°æ®
        uses: actions/checkout@v4
        with:
          repository: ne7359/mytvbox
          ref: publish
          path: code

      - name: è¯»å–TVæºæ•°æ®
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.user_godown }}
          ref: ${{ inputs.source_branch }}
          path: tv

      - name: åˆ é™¤X5ä»£ç      #æ³¨ï¼šé»˜è®¤ä¸æ”¯æŒX5å†…æ ¸
        if: ${{ inputs.x5kernel == 'NoAddx5kernel' }}
        working-directory: tv
        run: |
          sed -i "/variant.productFlavors\[0\].name == 'mobile'/s/'mobile')/'mobile' || variant.productFlavors[0].name == 'leanback')/" app/build.gradle

      - name: æ·»åŠ ç¼–è¯‘PY
        if: contains(env.GRADLE_TASKS, matrix.framework)
        working-directory: tv
        run: |
          sed -i '/proguardFiles getDefaultProguardFile/a\            signingConfig signingConfigs.debug' app/build.gradle
          sed -i '/ijkplayer/a\    implementation project('\'':pyramid'\'')' app/build.gradle
          sed -i 's/requests/requests==2.24.0/g' pyramid/build.gradle
          sed -i '/pycryptodome/a\                install '\''soupsieve==2.4'\''' pyramid/build.gradle
          sed -i '/ijkplayer/a\include '\''':pyramid''\''' settings.gradle
          echo 'æ·»åŠ ç¼–è¯‘PYå®Œæˆ'

      #- name: æ·»åŠ æ›´æ”¹
        #if: ${{ inputs.source_branch == 'release' }}    # å¦‚æœä¸ç­‰äºä½¿ç”¨if: ${{ inputs.source_branch != 'release' }}
        #working-directory: tv
        #run: |
          #sed -i '/ijkplayer/d' settings.gradle

      - name: diy
        working-directory: tv
        run: |
          sed -i 's/versionCode [0-9]*\.[0-9]*\.[0-9]*/versionCode ${{ env.codeteme }}/g' app/build.gradle
          echo 'versionCodeæ›´æ”¹å®Œæˆ'
          sed -i 's/versionName "[0-9]*\.[0-9]*\.[0-9]*"/versionName "QTM Build v${{ env.bteme }}"/g' app/build.gradle
          echo 'ç‰ˆæœ¬å·æ›´æ”¹å®Œæˆ'
          chmod +x $GITHUB_WORKSPACE/code/TVBox/data.sh
          $GITHUB_WORKSPACE/code/TVBox/data.sh

      - name: å®‰è£… Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: å®‰è£… Gradle
        uses: gradle/actions/setup-gradle@v3
        
      - name: ç”¨ Gradle æ„å»º apk
        working-directory: tv
        run: |
          bash gradlew ${{ matrix.framework}}
 
      - name: ç¼–è¯‘å®Œæˆæ—¶é—´
        run: |
          echo "ç¼–è¯‘å®Œæˆæ—¶é—´..."
          START_SECONDS=${{ env.START_SECONDS }}
          END_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          END_SECONDS=$(date --date="$END_TIME" +%s)
          SECONDS=$((END_SECONDS-START_SECONDS))
          HOUR=$(( $SECONDS/3600 )) && MIN=$(( ($SECONDS-${HOUR}*3600)/60 )) && SEC=$(( $SECONDS-${HOUR}*3600-${MIN}*60 ))
          echo "BUILD_TIME=${HOUR}æ—¶${MIN}åˆ†${SEC}ç§’" >> $GITHUB_ENV
          find tv/app/build/outputs/apk/ -name '*.apk' -exec echo {} \;
 
      - name: å‘å¸ƒä¿¡æ¯
        run: |
          echo -e "ğŸˆ ç¼–è¯‘æ—¶é—´ï¼š${{ env.tag }}\\n\\nâ° ç¼–è¯‘ç”¨æ—¶ï¼š${{ env.BUILD_TIME }}\\n\\nâ˜… æºç åˆ†æ”¯ï¼š${{ inputs.user_godown }} - ${{ inputs.source_branch }} v${{ env.VERSION }}\\n\\n--- " >> ${{ github.workspace }}-CHANGELOG.txt
          echo -e "<details><summary>TVç‰ˆå‡çº§ä¿¡æ¯</summary>" >> ${{ github.workspace }}-CHANGELOG.txt
          if [ "${{ inputs.source_branch }}" == "release" ]; then
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/main/apk/release/leanback.json' | jq -r '.desc')" >> ${{ github.workspace }}-CHANGELOG.txt
            echo "</details>\\n\\n<details><summary>ç§»åŠ¨ç‰ˆå‡çº§ä¿¡æ¯</summary>" >> ${{ github.workspace }}-CHANGELOG.txt
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/main/apk/release/mobile.json' | jq -r '.desc')" >> ${{ github.workspace }}-CHANGELOG.txt
            echo "</details>" >> ${{ github.workspace }}-CHANGELOG.txt

          elif [ "${{ inputs.source_branch }}" == "fongmi" ]; then
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/main/apk/release/leanback.json' | jq -r '.desc')" >> ${{ github.workspace }}-CHANGELOG.txt
            echo "</details>\\n\\n<details><summary>ç§»åŠ¨ç‰ˆå‡çº§ä¿¡æ¯</summary>" >> ${{ github.workspace }}-CHANGELOG.txt
            echo "$(curl -s 'https://raw.githubusercontent.com/FongMi/Release/main/apk/release/mobile.json' | jq -r '.desc')" >> ${{ github.workspace }}-CHANGELOG.txt
            echo "</details>" >> ${{ github.workspace }}-CHANGELOG.txt
          else
            echo 'æ²¡æœ‰åŒ¹é…é€€å‡ºå†™CHANGELOG.txt'
          fi
 
      - name: ä¸Šä¼ åˆ°å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          name: QTMå½±è§†
          tag_name: ${{ env.tag }}
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          files: ./tv/app/build/outputs/apk/*/release/*.apk
        env:
          GITHUB_TOKEN: ${{ github.token }} # ç»™æœ€é«˜çš„æƒé™

      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: 'MINGERTAI/MyALL'  # ç›®æ ‡ä»“åº“å
          token: ${{ secrets.GH_TOKEN }}  # ä½¿ç”¨è®¿é—®ä»¤ç‰Œ
          path: 'main'

      - name: ç§»åŠ¨ APK åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
        run: |
          mkdir -p main/Release/tvapk
          cp ./tv/app/build/outputs/apk/*/release/*.apk main/Release/tvapk/
          cp ${GITHUB_WORKSPACE}/CHANGELOG.txt main/Release/tvapk/Release.md

      - name: æ¨é€ APK åˆ°ç›®æ ‡ä»“åº“
        run: |
          cd main
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "è‡ªåŠ¨æ¨é€ APK" || exit 0  # é˜²æ­¢å¦‚æœæ²¡æœ‰æ–‡ä»¶å˜æ›´å¯¼è‡´çš„é”™è¯¯
          git push origin HEAD
        env:
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: github-actions@github.com
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: github-actions@github.com
